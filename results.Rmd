# Results

## xysong demo
```{r}
library(ggplot2)
library(ggeasy)
library(dplyr)
library(lubridate)
library(tidyverse)
# source("Utility/utils.R")

all_dsets <- read_all()
dumbo <- all_dsets[["dumbo"]]
class(dumbo)
# Elementary statistics
head(dumbo)
# TODO: (Xiaoyang) whether using detailed time or just date?
# dumbo$Datetime <- as.Date(dumbo$Datetime, "%Y-%m-%d %H:%M:%S")
date <- head(dumbo)$Datetime[1]
# lubridate::floor_date(date, "month")
date
# Example
head(dsets)

group_by <- function(df) {
    # Process dataframe
    dsets <- df %>%
        dplyr::mutate(Datetime = as.Date(Datetime, "%Y-%m-%d %H:%M:%S")) %>%
        dplyr::mutate(month = lubridate::floor_date(Datetime, "month")) %>%
        dplyr::group_by(month) %>%
        dplyr::summarise(avg = sum(Waiting.Time) / n())
    return(dsets)
}
plot_time_series <- function(dsets) { # Plot
    g <- ggplot(dsets, aes(month, avg), type = "l") +
        geom_line(color = "purple") +
        scale_x_date(date_labels = "%b %Y", date_breaks = "6 months", guide = guide_axis(angle = 45)) + # nolint
        xlab("Month") +
        ylab("Average Waiting Time") +
        ggtitle("Time Series Plot: Average Waiting Time (By Month)") +
        ggeasy::easy_center_title()
    # theme_grey(14)
    return(g)
}
identify_abnormal <- function(g, start, end, text_y) {
    g <- g + annotate("rect", xmin = start, xmax = end, ymin = -Inf, ymax = Inf, fill = "lightblue", alpha = 0.5) # nolint
    # Append text
    g <- g + annotate("text", x = end + 10, y = text_y *(2/3), label = "Covid Disruption", color = "black", hjust = 0) # nolint
    return(g)
}
grouped_dsets <- group_by(dumbo)
g <- plot_time_series(grouped_dsets)
start <- as.Date("2020-01-01")
end <- as.Date("2020-09-01")
g <- identify_abnormal(g, start, end, max(grouped_dsets$avg))
g
```




