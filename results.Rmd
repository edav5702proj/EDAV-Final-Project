# Results
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- <script src="D3/scripts/example.js"></script> -->
<script>
d3.select("img")
  .on("mouseover", function(event) {
    console.log("hello");
    const width = d3.select(event.currentTarget).attr("width");
    d3.select(event.currentTarget).transition().duration(2000).attr("width", 0.1 * width);
    });
d3.select("img")
  .on("mouseout", function(event) {
    console.log("hello1");
    const width = d3.select(event.currentTarget).attr("width");
    d3.select(event.currentTarget).transition().duration(2000).attr("width", 10 * width);
    });
</script>
## xysong demo

```{r}
process_name <- function(csv) {
    return(gsub("  ", "", gsub(".csv", "", gsub("_", " ", csv))))
}

get_attraction_name <- function() {
    return(lapply(list.files("Data/data/Magic Kingdom/xysong_python"), process_name)) # nolint
}
# get_attraction_name()


read_all <- function() {
    library(hash)
    filenames <- list.files("Data/data/Magic Kingdom/xysong_python") # nolint
    dict <- hash()
    for (csv in filenames) {
        dict[[process_name(csv)]] <- read.csv(sprintf("Data/data/Magic Kingdom/xysong_python/%s", csv)) # nolint
    }
    return(dict)
}
```
```{r}
library(ggplot2)
library(ggeasy)
library(dplyr)
library(lubridate)
library(tidyverse)
# source("Utility/utils.R")

all_dsets <- read_all()
dumbo <- all_dsets[["dumbo"]]
class(dumbo)
# Elementary statistics
head(dumbo)
# TODO: (Xiaoyang) whether using detailed time or just date?
# dumbo$Datetime <- as.Date(dumbo$Datetime, "%Y-%m-%d %H:%M:%S")
date <- head(dumbo)$Datetime[1]
# lubridate::floor_date(date, "month")
date
# Example
# head(dsets)
group_by <- function(df) {
    # Process dataframe
    dsets <- df %>%
        dplyr::mutate(Datetime = as.Date(Datetime, "%Y-%m-%d %H:%M:%S")) %>%
        dplyr::mutate(month = lubridate::floor_date(Datetime, "month")) %>%
        dplyr::group_by(month) %>%
        dplyr::summarise(avg = sum(Waiting.Time) / n())
    return(dsets)
}

plot_time_series <- function(dsets, name) { # Plot
    g <- ggplot(dsets, aes(month, avg), type = "l") +
        geom_line(color = "black") +
        scale_x_date(date_labels = "%b %Y", date_breaks = "6 months", guide = guide_axis(angle = 45)) + # nolint
        xlab("Month") +
        ylab("Average Waiting Time (minutes)") +
        ggtitle(sprintf("%s: Average Waiting Time (By Month)", name)) +
        ggeasy::easy_center_title()
    return(g)
}
identify_abnormal <- function(g, start, end, text_y) {
    g <- g + annotate("rect", xmin = start, xmax = end, ymin = -Inf, ymax = Inf, fill = "lightblue", alpha = 0.5) # nolint
    # Append text
    g <- g + annotate("text", x = end + 10, y = text_y * (2 / 3), label = "Covid \nDisruption", color = "black", hjust = 0) # nolint
    return(g)
}
grouped_dsets <- group_by(dumbo)
g <- plot_time_series(grouped_dsets, "dumbo")
start <- as.Date("2020-01-01")
end <- as.Date("2020-12-01")
g <- identify_abnormal(g, start, end, max(grouped_dsets$avg))
g
```
### Identify cyclical patterns
```{r, fig.show="hold", out.width="50%", fig.id="facet"}
dumbo <- all_dsets[["dumbo"]]
# dumbo
head(dumbo)
# sum(dumbo$Waiting.Time) / nrow(dumbo)
group_by_date <- function(df) {
    # Process dataframe
    dsets <- df %>%
        dplyr::mutate(Datetime = as.Date(Datetime, "%Y-%m-%d %H:%M:%S")) %>%
        dplyr::group_by(Datetime) %>%
        dplyr::summarise(avg = sum(Waiting.Time) / n()) %>%
        dplyr::mutate(yr = year(Datetime))
    return(dsets)
}
dset <- group_by_date(dumbo)
head(dset)
g <- ggplot(dset, aes(as.Date(format(Datetime, format = "%m-%d"), "%m-%d"), avg)) + # nolint
    geom_line(color = "grey30") +
    geom_point(size = 0.1) +
    scale_x_date(date_labels = "%b", date_breaks = "1 months", guide = guide_axis(angle = 45)) + # nolint
    facet_grid(yr ~ ., scale = "free_y") +
    geom_smooth(se = FALSE)
g
print(head(dset, 100), n = 100)
as.character(as.Date("2020/01/01"))
# grid.arrange(g,g, ncol=2)
g
g
g
head(dset, 100)
```





