# Data 

## Sources

## Cleaning / transformation

## Missing value analysis
```{r}
process_name <- function(csv) {
    return(gsub("  ", "", gsub(".csv", "", gsub("_", " ", csv))))
}

get_attraction_name <- function() {
    return(lapply(list.files("Data/data/Magic Kingdom/xysong_python"), process_name)) # nolint
}
# get_attraction_name() #nolint

read_all <- function() {
    library(hash)
    filenames <- list.files("Data/data/Magic Kingdom/xysong_python") # nolint
    dict <- hash()
    for (csv in filenames) {
        dict[[process_name(csv)]] <- read.csv(sprintf("Data/data/Magic Kingdom/xysong_python/%s", csv)) # nolint
    }
    return(dict)
}
```
```{r}
names <- get_attraction_name()
# names[[4]]
all_dsets <- read_all()
num_dsets <- length(all_dsets)
class(head(all_dsets[["dumbo"]]$Datetime))
# num_dsets
# Configure start/end date
start_date <- as.Date("2020-04-01")
end_date <- as.Date("2020-10-01")

dates <- c(
    "2020-04-01 12:00:00",
    "2020-05-01 12:00:00",
    "2020-06-01 12:00:00",
    "2020-07-01 12:00:00",
    "2020-08-01 12:00:00",
    "2020-09-01 12:00:00",
    "2020-10-01 12:00:00"
)
# Complementary dataframe
comp_df <- data.frame(
    "X" = c(0, 1, 2, 3, 4, 5, 6),
    "Datetime" = dates,
    "Waiting.Time" = rep(0, 7)
) # nolint
# Print out statistics
outliers <- rep(0, num_dsets)
for (i in 1:num_dsets) {
    name <- names[[i]]
    date_df <- as.Date(all_dsets[[name]]$Datetime, "%Y-%m-%d %H:%M:%S")
    mask <- date_df > start_date & date_df < end_date
    outliers[[i]] <- sum(mask)
    all_dsets[[name]]$Waiting.Time[mask] <- rep(as.numeric(0.0), sum(mask))
    # add complementary data frames
    all_dsets[[name]] <- bind_rows(list(all_dsets[[name]], comp_df))
    write.csv(all_dsets[[name]], sprintf("Data/data/cleaned/%s.csv", name))
}

num_vals <- rep(0, 25)
for (i in 1:25) {
    name <- names[[i]]
    num_vals[[i]] <- nrow(all_dsets[[name]])
}
num_vals
names[14]
```

```{r}
missing_values <- read.csv("Data/data/entity_missing.csv")
# Replace all NaN with NA
mask <- is.nan(missing_values$duration)
missing_values$duration[mask] <- NA
mask <- is.nan(missing_values$avg)
missing_values$avg[mask] <- NA
# missing_values
missing_dsets <- missing_values %>%
    # rownames_to_column("id") %>%
    gather(key, value, -c(X)) %>%
    mutate(missing = ifelse(is.na(value), "yes", "no"))

g <- ggplot(missing_dsets, aes(x = key, y = X, fill = missing)) +
    geom_tile(color = "white") +
    ggtitle("mtcars with NAs added") +
    ylab("") +
    scale_fill_viridis_d() + # discrete scale
    theme_bw()
g
```
